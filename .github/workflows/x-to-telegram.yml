name: X → Telegram

on:
  schedule:
    # Every hour (UTC)
    - cron: "0 * * * *"
  # Manual trigger from the Actions tab
  workflow_dispatch:
    inputs:
      max-per-run:
        description: 'Maximum tweets to process per run'
        required: false
        default: '50'
        type: string
      dry-run:
        description: 'Run in dry-run mode (no actual posting)'
        required: false
        default: false
        type: boolean
      tweet-id:
        description: 'Specific tweet ID to post (overrides timeline fetching)'
        required: false
        type: string

# Avoid overlapping runs if one is still in progress
concurrency:
  group: x-to-telegram
  cancel-in-progress: true

jobs:
  run-script:
    runs-on: ubuntu-latest
    # Keep the runner from idling too long; the script now exits fast on 429s
    timeout-minutes: 5

    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.X_BEARER_TOKEN }}" ]; then
            echo "❌ Error: X_BEARER_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.X_USERNAME }}" ]; then
            echo "❌ Error: X_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ]; then
            echo "❌ Error: TELEGRAM_BOT_TOKEN secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "❌ Error: TELEGRAM_CHAT_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.STATE_GIST_ID }}" ]; then
            echo "❌ Error: STATE_GIST_ID secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.GIST_TOKEN }}" ]; then
            echo "❌ Error: GIST_TOKEN secret is not set"
            exit 1
          fi
          echo "✅ All required secrets are configured"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Fetch and post tweets
        id: run-script
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_USERNAME: ${{ secrets.X_USERNAME }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          STATE_GIST_ID: ${{ secrets.STATE_GIST_ID }}
          GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        run: |
          set -o pipefail
          MAX_PER_RUN="${{ github.event.inputs.max-per-run || '50' }}"
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
          fi
          TWEET_ID_FLAG=""
          if [ -n "${{ github.event.inputs.tweet-id }}" ]; then
            TWEET_ID_FLAG="--tweet-id ${{ github.event.inputs.tweet-id }}"
          fi
          node x_to_telegram.js --max-per-run "$MAX_PER_RUN" $DRY_RUN_FLAG $TWEET_ID_FLAG 2>&1 | tee run.log

          # Extract summary from logs
          TWEET_COUNT=$(grep -c "\[posted\]" run.log 2>/dev/null || true)
          TWEET_COUNT=${TWEET_COUNT:-0}
          echo "tweets_posted=${TWEET_COUNT}" >> $GITHUB_OUTPUT
        continue-on-error: false

      - name: Create job summary
        if: always()
        run: |
          echo "## X → Telegram Feed Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-script.outcome }}" = "success" ]; then
            echo "**Status:** ✅ Success" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ❌ Failed" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Tweets Posted:** ${{ steps.run-script.outputs.tweets_posted || '0' }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.dry-run }}" = "true" ]; then
            echo "**Dry Run:** Yes" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Timestamp:** $(TZ=Europe/Amsterdam date +'%d-%m-%Y %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.run-script.outcome }}" != "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ⚠️ Error Details" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -n 20 run.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No logs available"
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
